blueprint:
  name: "Svitlo Live: –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –∑–º—ñ–Ω—É —Ä–æ–∑–∫–ª–∞–¥—É"
  description: "–ù–∞–¥—Å–∏–ª–∞—î push –∫–æ–ª–∏ —Ä–æ–∑–∫–ª–∞–¥ –µ–ª–µ–∫—Ç—Ä–æ–ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è –∑–º—ñ–Ω—é—î—Ç—å—Å—è"
  domain: automation
  source_url: https://github.com/chaichuk/svitlo_live
  input:
    schedule_calendar:
      name: –ö–∞–ª–µ–Ω–¥–∞—Ä Svitlo Live
      selector:
        entity:
          domain: calendar
          integration: svitlo_live
    
    schedule_updated_sensor:
      name: –°–µ–Ω—Å–æ—Ä –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥—É
      description: "–û–±–µ—Ä—ñ—Ç—å sensor 'Schedule updated' –¥–ª—è —Ü—å–æ–≥–æ —Ä–µ–≥—ñ–æ–Ω—É (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ñ—ñ–ª—å—Ç—Ä—É—î—Ç—å—Å—è)"
      selector:
        entity:
          domain: sensor
          integration: svitlo_live
    
    mobile_targets:
      name: –ú–æ–±—ñ–ª—å–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó
      default: []
      selector:
        device:
          integration: mobile_app
          multiple: true
    
    title_text:
      name: –ó–∞–≥–æ–ª–æ–≤–æ–∫
      default: "‚ö†Ô∏è –†–æ–∑–∫–ª–∞–¥ —Å–≤—ñ—Ç–ª–∞ –∑–º—ñ–Ω–∏–≤—Å—è!"
      selector:
        text:
    
    storage_helper:
      name: Helper –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
      description: "–í–∏–±–µ—Ä—ñ—Ç—å Text helper –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å—Ç–∞–Ω—É —Ü—å–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è"
      selector:
        entity:
          domain: input_text

mode: restart

variables:
  cal_entity: !input schedule_calendar
  mobile_targets: !input mobile_targets
  title_text: !input title_text
  storage_helper: !input storage_helper
  # –í–∏—Ç—è–≥—É—î–º–æ –Ω–∞–∑–≤—É —Ä–µ–≥—ñ–æ–Ω—É —Ç–∞ —á–µ—Ä–≥–∏ –∑ entity_id –∫–∞–ª–µ–Ω–¥–∞—Ä—è
  region_queue: >-
    {% set parts = cal_entity.split('_') %}
    {% if parts | length >= 4 %}
      {{ parts[1] | title }} {{ parts[2] | title }}, —á–µ—Ä–≥–∞ {{ parts[3:] | join('.') }}
    {% else %}
      {{ cal_entity.split('.')[1] | replace('_', ' ') | title }}
    {% endif %}

trigger:
  - platform: state
    entity_id: !input schedule_updated_sensor

condition:
  - condition: template
    value_template: "{{ trigger.from_state.state not in ['unknown', 'unavailable'] }}"

action:
  # –û—Ç—Ä–∏–º—É—î–º–æ —Ä–æ–∑–∫–ª–∞–¥ —Ç—ñ–ª—å–∫–∏ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ
  - service: calendar.get_events
    target:
      entity_id: !input schedule_calendar
    data:
      start_date_time: "{{ today_at('00:00').isoformat() }}"
      end_date_time: "{{ today_at('23:59:59').isoformat() }}"
    response_variable: cal_resp
  
  - variables:
      raw_events: >-
        {% set r = cal_resp %}{% set k = cal_entity %}
        {% if r is mapping and (k in r) and (r[k] is mapping) and ('events' in r[k]) %}
          {{ r[k]['events'] | sort(attribute='start') }}
        {% else %}[]{% endif %}
      
      # –°—Ç–≤–æ—Ä—é—î–º–æ hash —Ä–æ–∑–∫–ª–∞–¥—É (–ø–æ–≤–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç)
      schedule_signature: >-
        {% set ns = namespace(sig='') %}
        {% for e in raw_events %}
          {% set ns.sig = ns.sig ~ e.start[:16] ~ e.end[:16] ~ '|' %}
        {% endfor %}
        {{ ns.sig }}
      
      # –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π hash
      old_signature: "{{ states(storage_helper) | default('') }}"
      
      # –ß–∏ –∑–º—ñ–Ω–∏–ª–æ—Å—è?
      changed: "{{ schedule_signature != old_signature and old_signature != '' }}"

  - if:
      - condition: template
        value_template: "{{ changed }}"
    then:
      - variables:
          events_today: "{{ raw_events }}"
          
          body: >-
            üìç {{ region_queue }}

            {% if events_today | length > 0 -%}
            üìÖ {{ now().strftime('%d.%m.%Y') }}
            
            {% for e in events_today -%}
            {%- set s = as_datetime(e.start).astimezone(now().tzinfo) -%}
            {%- set end = as_datetime(e.end).astimezone(now().tzinfo) -%}
            ‚ùå  {{ s.strftime('%H:%M') }} ‚îÅ {{ end.strftime('%H:%M') }}

            {% endfor -%}
            {%- else -%}
            –°–¨–û–ì–û–î–ù–Ü ({{ now().strftime('%d.%m.%Y') }}):

            ‚ö°  –°–≤—ñ—Ç–ª–æ –±—É–¥–µ –≤–µ—Å—å –¥–µ–Ω—å!  ‚ö°  
            {%- endif %}

      - choose:
          - conditions: "{{ mobile_targets | length > 0 }}"
            sequence:
              - repeat:
                  for_each: !input mobile_targets
                  sequence:
                    - variables:
                        svc: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | lower | replace(' ', '_') | replace('-', '_') }}"
                    - service: "{{ svc }}"
                      data:
                        title: "{{ title_text }}"
                        message: "{{ body }}"
                        data:
                          priority: high
                          tag: svitlo_changed
                          notification_icon: "mdi:calendar-alert"
  
  # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ hash (–æ–±—Ä—ñ–∑–∞—î–º–æ –¥–æ 255 —Å–∏–º–≤–æ–ª—ñ–≤)
  - service: input_text.set_value
    target:
      entity_id: !input storage_helper
    data:
      value: "{{ schedule_signature[:255] }}"
